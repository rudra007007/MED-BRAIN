// Prisma Schema for MED-BRAIN Backend
// PostgreSQL (Supabase) with UUIDs for secure, distributed ID generation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL
// ============================================
// Anonymous user support for privacy-first design
// Users are identified only by UUID, no email or personal data collected

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Relationships
  dailyMetrics DailyMetric[]
  aiInsights   AIInsight[]

  @@map("users")
}

// ============================================
// DAILY METRIC MODEL
// ============================================
// Stores daily health metrics for each user
// Unique constraint on (userId, date) to prevent duplicate entries per day

model DailyMetric {
  id     String   @id @default(uuid())
  userId String
  date   DateTime @db.Date // Date only, no time component

  // Sleep metrics (nullable for flexibility)
  sleepStart    DateTime? @db.Time // When user went to sleep
  sleepEnd      DateTime? @db.Time // When user woke up
  sleepDuration Float? // Calculated in hours

  // Activity metrics
  screenTime      Float @default(0) // In hours
  activityMinutes Int   @default(0) // Active minutes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_metrics")
}

// ============================================
// AI INSIGHT MODEL
// ============================================
// Stores AI-generated insights, suggestions, and confidence scores
// Phase indicates cold-start state: 0 (<7 days), 1 (7-29 days), 2 (>=30 days)

model AIInsight {
  id     String   @id @default(uuid())
  userId String
  date   DateTime @db.Date

  // AI Analysis Results
  phase       Int // 0: global priors, 1: blended, 2: personalized
  confidence  Float // AI confidence score (0.0 to 1.0)
  suggestions String[] // Array of personalized suggestion strings
  stats       Json // Object with analysis statistics

  createdAt DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("ai_insights")
}
